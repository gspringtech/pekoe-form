<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <style type="text/css">
        body, html {margin:0; margin-bottom: 10em;}
        #workarea {
            height: 100%; width:100%;
            position: relative;
        }
    </style>
    <title>Pekoe Form</title>
    <script>
        var gs;
    </script>
    <!--<link rel='stylesheet' href='/pekoe-common/dist/css/bootstrap.css' />-->

    <!--<link rel="stylesheet" href="lib/ckeditor/contents.css"/> &lt;!&ndash; TODO this interferes with the page. is it needed? &ndash;&gt;-->
    <link rel='stylesheet' href='/pekoe-common/dist/font-awesome/css/font-awesome.min.css' />
    <link rel="stylesheet" href="/pekoe-common/jquery-ui-themes-1.11.0/themes/ui-lightness/jquery-ui.min.css" />
    <link rel="stylesheet" href="   lib/jquery-simple-context-menu/jquery.contextmenu.css"/>

    <link rel="stylesheet" href="css/decoration.css"/>
    <link rel="stylesheet" href="css/form-decoration.css"/>
    <link rel="stylesheet" href="css/bag-nav.css" />
    <link rel="stylesheet" href="css/print.css" type="text/css" media="print" />

    <script src="lib/jquery-2.1.1.js"></script>
    <script src="lib/jquery-ui-1.11.0/jquery-ui.js" ></script>
    <script src="/pekoe-common/bower_components/globalize/lib/globalize.js" ></script>
    <script type='text/javascript' src='/pekoe-common/dist/js/bootstrap.min.js' ></script>
    <script src="lib/ckeditor/ckeditor.js"></script>
    <script src="lib/ckeditor/adapters/jquery.js"></script>
    <link rel="stylesheet" href="lib/ckeditor/contents.css"/>

    <script src="bureau-a-gradin.js"></script>
    <script src="utilities.js"></script>
    <script src="Utility.js"></script>
    <script src="pekoeForm_widget.js"></script>
    <script src="pekoeFile.js"></script>
    <script src="InputMaker.js"></script>
    <script src="PekoeForm.js"></script>
    <script src="pekoeLookup_widget.js"></script>

    <script>
        /*
        At the moment, tabs.ctrl is checking this dirty flag before closing the window.

         */

        /*
         var search = location.search.substring(1);
         search ? JSON.parse('{"' + search.replace(/&/g, '","').replace(/=/g,'":"') + '"}',
         function(key, value) { return key===""?value:decodeURIComponent(value) }):{}

         */
        var dirty = false;


        $(function () {

            gs.cookies = document.cookie.split('; ');

            gs.service = (function (){
                var s = {};
                if (window.parent !== window) { // must be a child frame
                    s = window.parent.AuthService;
                } else {
                    s.getTenant = function () {
                        return document.cookie;
                    }
                }
                return s;
            })();

            var bagLoaded = new $.Deferred();
            var templateSelector = new gs.Pekoe.BureauAG("#bagNav");
            gs.bag = templateSelector;
            templateSelector.load(bagLoaded);

            $("#templateItems").on("click", "span", function (e) {
                var $span = $(this);

                if ($span.hasClass("irrelevant")) {jQuery.statusMessage("that template doesn't apply to this file"); return; }
                $span.addClass("active");
                panel.pekoeForm("setTemplate",$span.attr("title"));
                $span.siblings().removeClass("active");
            });

            var panel = $("<div></div>").attr("id","formDiv").appendTo('#workarea');
            var args = gs.Utility.getArgs();
            panel.pekoeForm({bag:bagLoaded}).pekoeForm("setFile",gs.Pekoe.pekoeFile({"href":args.job}));

            window.pekoeClose = function () { // See TabsService.
                if (!dirty || confirm('Close form without Saving?')) {
                    // TODO improve this so that errors don't prevent the tab from closing.
                    panel.remove(); // this results in a call to pekoeFile.release which then calls readyToClose in tabs.service
                    return true;
                }
            };

        });

    </script>
</head>
<body>
<div id="bag"><!-- ******************* New Template Panel *********************** -->
    <div id="bagHomeRow">
        <div id="bagstart" class='folder'>Templates</div>
    </div>

    <div id="bagNav" style='clear:both;'></div><!-- clear the floats above -->
    <div id="templateItems"></div>

</div>
<div id="workarea">
    
</div>
<div id="status" style="position:fixed; top:30px"></div>
</body>
</html>